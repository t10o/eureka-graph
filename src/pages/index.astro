---
import Layout from '../layouts/Layout.astro';
import { fetchAllMonthlyData } from '../api/myslo.js';
import { 
    extractPlayGraphJsonBlocks, 
    selectTargetGraph, 
    toSeries, 
    detectCensorFlags, 
    parseActualGamesFromHtml,
    extrapolateAug31 
} from '../playgraph-utils.js';

// buildCumulativeé–¢æ•°ï¼ˆç´¯ç©ãƒ‡ãƒ¼ã‚¿ã®ä½œã‚Šç›´ã—ï¼‰
type DayPoints = { day: string; points: { game: number; diff: number; extrapolated?: boolean }[] };

function buildCumulative(daySeries: DayPoints[]) {
    // æ—¥ä»˜é †ã«ä¸¦ã¹ã‚‹
    const days = [...daySeries].sort((a, b) => a.day.localeCompare(b.day));

    const out: { x: number; y: number; day: string; extrapolated?: boolean }[] = [];
    let cumGame = 0;   // ç´¯ç©ã‚²ãƒ¼ãƒ æ•°ï¼ˆå‰æ—¥çµ‚ç«¯ã‚’åŠ ç®—ï¼‰
    let offset  = 0;   // ç´¯ç©å·®æš    ï¼ˆå‰æ—¥çµ‚ç«¯ã‚’åŠ ç®—ï¼‰

    for (const d of days) {
        if (!d.points?.length) continue;

        // å¿µã®ãŸã‚æ—¥å†…ã‚’æ˜‡é †ã‚½ãƒ¼ãƒˆ
        d.points.sort((a,b)=>a.game-b.game);

        // æ—¥å†…ã®å…ˆé ­ã‚’0èµ·ç‚¹ã«ãã‚ãˆã‚‹ï¼ˆæ—¥å†… diff ãŒçµ¶å¯¾å€¤ãªã‚‰ã€ã“ã“ã§æ—¥å†…ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’å¼•ãï¼‰
        const dayBaseDiff = d.points[0].diff;
        const dayStartGame = d.points[0].game;

        for (const p of d.points) {
            const x = cumGame + (p.game - dayStartGame);      // ç´¯ç©ã‚²ãƒ¼ãƒ æ•°
            const y = offset   + (p.diff - dayBaseDiff);      // ç´¯ç©å·®æš
            out.push({ x, y, day: d.day, extrapolated: !!p.extrapolated });
        }

        // ã“ã®æ—¥ã®çµ‚ç«¯ã§ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’æ›´æ–°
        const last = d.points[d.points.length - 1];
        cumGame += last.game - dayStartGame;                 // ä»Šæ—¥ã¶ã‚“ã‚’åŠ ç®—
        offset  += last.diff - dayBaseDiff;                  // ä»Šæ—¥ã¶ã‚“ã‚’åŠ ç®—
    }

    // ç¸¦è»¸ã®ã‚¼ãƒ­åŸºæº–ï¼ˆæœ€å¤ã‚’0ï¼‰
    const base = out[0]?.y ?? 0;
    for (const p of out) p.y -= base;

    // xãƒ»y ã®ä¸æ­£ï¼†é‡è¤‡ x ã‚’é™¤å»
    const seen = new Set<number>();
    const clean: typeof out = [];
    for (const p of out) {
        if (!Number.isFinite(p.x) || !Number.isFinite(p.y)) continue;
        const k = +p.x.toFixed(6);
        if (seen.has(k)) continue;
        seen.add(k);
        clean.push(p);
    }
    // å¿µã®ãŸã‚æ˜‡é †
    clean.sort((a,b)=>a.x-b.x);
    return clean;
}

// ãƒ“ãƒ«ãƒ‰æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
let chartData: any = null;
let points: any[] = [];
let summaries: any[] = [];

try {
    // å…¨æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const monthlyData = await fetchAllMonthlyData();
    
    // å„æœˆã®HTMLã‚’å‡¦ç†ã—ã¦æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
    const daySeriesData = [];
    const summariesData = [];
    const dayOrder = [];
    
    for (const monthData of monthlyData) {
        // æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ—¥ä»˜ã‚’ç”Ÿæˆï¼ˆä»®æƒ³çš„ãªæ—¥ä»˜ï¼‰
        const dateStr = monthData.date.toISOString().split('T')[0];
        
        // HTMLã‚’å‡¦ç†
        const html = monthData.html;
        
        try {
            // PlayGraphãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
            const blocks = extractPlayGraphJsonBlocks(html);
            if (blocks.length === 0) {
                console.warn(`No PlayGraph data found for: ${dateStr}`);
                continue;
            }
            
            // å¯¾è±¡ã‚°ãƒ©ãƒ•ã‚’é¸æŠ
            const targetGraph = selectTargetGraph(blocks);
            if (!targetGraph) {
                console.warn(`No valid target graph found for: ${dateStr}`);
                continue;
            }
            
            // å®Ÿã‚²ãƒ¼ãƒ æ•°ã‚’æŠ½å‡º
            const actualGames = parseActualGamesFromHtml(html);
            
            // SeriesPointã«å¤‰æ›ï¼ˆå®Ÿã‚²ãƒ¼ãƒ æ•°ã«åˆã‚ã›ã¦å†ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
            let series = toSeries(targetGraph, actualGames);
            
            // æ¤œé–²ãƒ•ãƒ©ã‚°ã‚’æ¤œå‡º
            const censorFlags = detectCensorFlags(targetGraph, series, actualGames);
            
            // 8/31ã®ç‰¹åˆ¥æ‰±ã„
            let specialRuleApplied = false;
            let extrapolatedPointsCount = 0;
            
            if (dateStr === '2024-08-31') {
                series = extrapolateAug31(series, 10073, -3000, 50);
                specialRuleApplied = true;
                extrapolatedPointsCount = series.filter(p => p.extrapolated).length;
            }
            
            // æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            const points = series.map(s => ({
                game: s.game,
                diff: s.diff,
                extrapolated: s.extrapolated
            }));
            daySeriesData.push({ day: dateStr, points });
            
            // ã‚µãƒãƒªã‚’ä½œæˆ
            const lastPoint = series[series.length - 1];
            const summary = {
                day: dateStr,
                lastDiff: lastPoint.diff,
                actualGames,
                censoredRight: censorFlags.censoredRight,
                censoredBottom: censorFlags.censoredBottom,
                specialRuleApplied,
                extrapolatedPointsCount,
                isCensoredRight: actualGames ? actualGames > 8000 && lastPoint.game < actualGames * 0.9 : false
            };
            summariesData.push(summary);
            dayOrder.push(dateStr);
            
        } catch (error) {
            console.error(`Error processing ${dateStr}:`, error);
        }
    }
    
    // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
    dayOrder.sort();
    summariesData.sort((a, b) => a.day.localeCompare(b.day));
    
    // buildCumulativeé–¢æ•°ã§ç´¯ç©ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
    points = buildCumulative(daySeriesData);
    
    // ãƒ‡ãƒ¼ã‚¿ç›£æŸ»
    for (let i = 1; i < points.length; i++) {
        if (points[i].x < points[i-1].x) {
            throw new Error(`xãŒå¾Œé€€: idx=${i} ${points[i-1].x} -> ${points[i].x}`);
        }
    }
    console.log("OK: xã¯å˜èª¿å¢—åŠ ã€‚æœ€çµ‚x=", points.at(-1)?.x, "æœ€çµ‚y=", points.at(-1)?.y);
    
    // Xè»¸ã®æœ€å¤§å€¤ã‚’2000ã®å€æ•°ã«ä¸¸ã‚ã‚‹
    const maxX = Math.ceil((points.at(-1)?.x ?? 0) / 2000) * 2000;
    
    // Chart.jsç”¨ã®ãƒ‡ãƒ¼ã‚¿å½¢å¼ã«å¤‰æ›
    chartData = {
        datasets: [{
            label: "ç´¯ç©åæ”¯",
            data: points,               // {x, y, day, extrapolated?}
            parsing: false,             // x/y ã‚’ãã®ã¾ã¾ä½¿ã†
            showLine: true,             // ç‚¹ã ã‘ã«ãªã‚‹ã®ã‚’é˜²ã
            borderWidth: 2,
            pointRadius: 1.5,
            pointHoverRadius: 2,
            fill: false,
            segment: {
                // å¤–æŒ¿åŒºé–“ã ã‘ç ´ç·š
                borderDash: (ctx: any) => {
                    const a = ctx.p0?.raw as any, b = ctx.p1?.raw as any;
                    return (a?.extrapolated || b?.extrapolated) ? [6,4] : undefined;
                }
            }
        }],
        maxX: maxX
    };
    
    summaries = summariesData;
    
} catch (error) {
    console.error('Error generating chart data:', error);
    chartData = null;
    points = [];
    summaries = [];
}
---

<Layout title="ãƒã‚¤ã‚¹ãƒ­é€šç®—ã‚°ãƒ©ãƒ•">
	<div class="dashboard">
		<div class="container">
			<div class="hero">
				<h2 class="hero-title">ğŸ“Š é€šç®—ãƒ‡ãƒ¼ã‚¿åˆ†æ</h2>
				<p class="hero-description">2023å¹´12æœˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®å®Ÿæˆ¦ãƒ‡ãƒ¼ã‚¿ã‚’å¯è¦–åŒ–</p>
			</div>
			
			{chartData ? (
				<div id="graph-container" class="graph-container">
					<div class="graph-header">
						<h3 class="graph-title">ğŸ“ˆ ç´¯ç©åæ”¯ã‚°ãƒ©ãƒ•</h3>
						<div class="graph-legend">
							<div class="legend-item">
								<div class="legend-color real"></div>
								<span>å®Ÿãƒ‡ãƒ¼ã‚¿</span>
							</div>
							<div class="legend-item">
								<div class="legend-color extrapolated"></div>
								<span>å¤–æŒ¿ãƒ‡ãƒ¼ã‚¿ï¼ˆ8/31ï¼‰</span>
							</div>
						</div>
					</div>
					<div class="graph-wrapper">
						<canvas id="cumulative_graph" width="800" height="400"></canvas>
					</div>
					
					<div id="stats" class="stats-container">
						<h3 class="stats-title">ğŸ“‹ çµ±è¨ˆæƒ…å ±</h3>
						<div id="stats-content" class="stats-grid">
							{points.length > 0 && (
								<>
									<div class="stat-item">
										<span class="stat-label">ç·ã‚²ãƒ¼ãƒ æ•°</span>
										<span class="stat-value">{points[points.length - 1]?.x?.toLocaleString()}G</span>
									</div>
									<div class="stat-item">
										<span class="stat-label">ç·åæ”¯ï¼ˆæ­£è¦åŒ–å¾Œï¼‰</span>
										<span class="stat-value">{points[points.length - 1]?.y?.toLocaleString()}æš</span>
									</div>
									<div class="stat-item">
										<span class="stat-label">ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆæ•°</span>
										<span class="stat-value">{points.length}å€‹</span>
									</div>
									{summaries.find(s => s.day === '2024-08-31' && s.specialRuleApplied) && (
										<div class="stat-item">
											<span class="stat-label">8/31å¤–æŒ¿ãƒã‚¤ãƒ³ãƒˆ</span>
											<span class="stat-value">{summaries.find(s => s.day === '2024-08-31')?.extrapolatedPointsCount}å€‹</span>
										</div>
									)}
								</>
							)}
						</div>
					</div>
				</div>
			) : (
				<div class="error-state">
					<div class="error-icon">âš ï¸</div>
					<h3 class="error-title">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
					<p class="error-description">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¾ãŸã¯å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>
				</div>
			)}
		</div>
	</div>
</Layout>

<style>
	.dashboard {
		min-height: calc(100vh - 200px);
	}

	.hero {
		text-align: center;
		margin-bottom: 3rem;
		padding: 2rem 0;
	}

	.hero-title {
		font-size: 2.5rem;
		font-weight: 700;
		color: #1f2937;
		margin: 0 0 1rem 0;
	}

	.hero-description {
		font-size: 1.2rem;
		color: #6b7280;
		margin: 0;
	}

	.loading-state {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		padding: 4rem 2rem;
		background: #ffffff;
		border: 1px solid #e5e7eb;
		border-radius: 8px;
		box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
	}

	.loading-spinner {
		width: 40px;
		height: 40px;
		border: 4px solid #e5e7eb;
		border-top: 4px solid #3b82f6;
		border-radius: 50%;
		animation: spin 1s linear infinite;
		margin-bottom: 1rem;
	}

	@keyframes spin {
		0% { transform: rotate(0deg); }
		100% { transform: rotate(360deg); }
	}

	.loading-text {
		font-size: 1.1rem;
		color: #6b7280;
		margin: 0;
	}

	.graph-container {
		background: #ffffff;
		border: 1px solid #e5e7eb;
		border-radius: 8px;
		box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
		overflow: hidden;
	}

	.graph-header {
		padding: 1.5rem;
		border-bottom: 1px solid #e5e7eb;
		display: flex;
		justify-content: space-between;
		align-items: center;
		flex-wrap: wrap;
		gap: 1rem;
	}

	.graph-title {
		font-size: 1.25rem;
		font-weight: 600;
		color: #1f2937;
		margin: 0;
	}

	.graph-legend {
		display: flex;
		gap: 1.5rem;
		flex-wrap: wrap;
	}

	.legend-item {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		font-size: 0.875rem;
		color: #6b7280;
	}

	.legend-color {
		width: 12px;
		height: 12px;
		border-radius: 2px;
	}

	.legend-color.real {
		background: #ef4444;
	}

	.legend-color.extrapolated {
		background: repeating-linear-gradient(
			45deg,
			#ef4444,
			#ef4444 4px,
			transparent 4px,
			transparent 8px
		);
	}

	.graph-wrapper {
		padding: 1.5rem;
		background: white;
	}

	.graph-wrapper canvas {
		width: 100%;
		height: auto;
		border-radius: 4px;
	}

	.stats-container {
		padding: 1.5rem;
		background: #f9fafb;
		border-top: 1px solid #e5e7eb;
	}

	.stats-title {
		font-size: 1.125rem;
		font-weight: 600;
		color: #1f2937;
		margin: 0 0 1rem 0;
	}

	.stats-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
		gap: 1rem;
	}

	.stat-item {
		background: white;
		padding: 1rem;
		border-radius: 6px;
		border: 1px solid #e5e7eb;
	}

	.stat-label {
		font-weight: 500;
		color: #6b7280;
		font-size: 0.875rem;
		margin-bottom: 0.25rem;
		display: block;
	}

	.stat-value {
		font-size: 1.25rem;
		font-weight: 600;
		color: #1f2937;
		margin: 0;
	}

	.error-state {
		text-align: center;
		padding: 3rem 2rem;
		background: #ffffff;
		border: 1px solid #e5e7eb;
		border-radius: 8px;
		box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
	}

	.error-icon {
		font-size: 2rem;
		margin-bottom: 1rem;
	}

	.error-title {
		font-size: 1.25rem;
		font-weight: 600;
		color: #ef4444;
		margin: 0 0 0.5rem 0;
	}

	.error-description {
		color: #6b7280;
		margin: 0;
	}

	@media (max-width: 768px) {
		.hero-title {
			font-size: 2rem;
		}
		
		.hero-description {
			font-size: 1rem;
		}
		
		.graph-header {
			flex-direction: column;
			align-items: flex-start;
			padding: 1.5rem;
		}
		
		.graph-wrapper {
			padding: 1rem;
		}
		
		.stats-container {
			padding: 1.5rem;
		}
		
		.stats-grid {
			grid-template-columns: 1fr;
		}
	}
</style>

<script define:vars={{ chartData, points, summaries }}>
    // Chart.jsã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿
    const chartScript = document.createElement('script');
    chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    document.head.appendChild(chartScript);
    
    chartScript.onload = () => {
        if (chartData && chartData.datasets) {
            // Chart.jsã§ã‚°ãƒ©ãƒ•ã‚’æç”»
            const canvas = document.getElementById('cumulative_graph');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;
            
            const maxX = chartData.maxX;
            
            new Chart(ctx, {
                type: "line",
                data: {
                    datasets: chartData.datasets
                },
                options: {
                    parsing: false,
                    spanGaps: false,              // null ã§ç·šã‚’åˆ‡ã‚‹å ´åˆã¯ false ã®ã¾ã¾
                    plugins: { legend: { display: true } },
                    scales: {
                        x: {
                            type: "linear",
                            min: 0,
                            max: maxX,
                            ticks: { stepSize: 2000, callback: (v) => `${v}G` },
                            title: { display: true, text: "ã‚²ãƒ¼ãƒ æ•° (G)" },
                        },
                        y: {
                            title: { display: true, text: "ç´¯ç©å·®æš (æš)" },
                        }
                    }
                }
            });
        }
    };
    
    chartScript.onerror = () => {
        console.error('Failed to load Chart.js script');
    };
</script>